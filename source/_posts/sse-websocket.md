---
title: "(è¯‘) Server-Sent Events: the alternative to WebSockets you should be using"
toc: true
comments: true
popular_posts: false
mathjax: true
pin: false
headimg: https://s1.ax1x.com/2023/03/11/ppKuToT.jpg
date: 2023-03-11 14:26:29
tags: [Websocket, SSE, Python]
categories: SSE
keywords: "Server-Sent Events"
---

> åŸæ–‡åœ°å€: [https://germano.dev/sse-websockets/](https://germano.dev/sse-websockets/)
> ä½œè€…: [Germano Gabbianelli](https://github.com/tyrion)

å½“å¼€å‘å®æ—¶ web åº”ç”¨æ—¶ï¼ŒWebSockets å¯èƒ½æ˜¯æˆ‘ä»¬é¦–å…ˆæƒ³åˆ°çš„ã€‚ç„¶è€Œï¼ŒServer Sent Events (SSE) æ˜¯é€šå¸¸ä¼šæ˜¯ä¸€ç§æ›´ç®€å•çš„æ›¿ä»£æ–¹æ¡ˆã€‚

## 1. åºè¨€

æœ€è¿‘æˆ‘å¯¹å®ç°å®æ—¶ Web åº”ç”¨ç¨‹åºçš„ä¸€äº›æœ€ä½³æ–¹å¼å¾ˆæ„Ÿå…´è¶£ã€‚ä¹Ÿå°±æ˜¯ä¸€ä¸ªåº”ç”¨ç¨‹åºåŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªç»„ä»¶ï¼Œè¿™äº›ç»„ä»¶ä¼šæ ¹æ®æŸäº›å¤–éƒ¨äº‹ä»¶è‡ªåŠ¨å®æ—¶æ›´æ–°ã€‚è¿™ç§åº”ç”¨ç¨‹åºçš„æœ€å¸¸è§ä¾‹å­æ˜¯æ¶ˆæ¯æœåŠ¡ï¼Œæˆ‘ä»¬å¸Œæœ›æ¯æ¡æ¶ˆæ¯éƒ½èƒ½ç«‹å³å¹¿æ’­åˆ°æ‰€æœ‰å·²ç»è¿æ¥çš„äººï¼Œè€Œä¸éœ€è¦è¿›è¡Œä»»ä½•çš„ç”¨æˆ·äº¤äº’ã€‚

ç»è¿‡ä¸€äº›ç ”ç©¶ï¼Œæˆ‘å¶ç„¶å‘ç°äº† Martin Chaov çš„ä¸€ä¸ª[ç²¾å½©åˆ†äº«](https://www.youtube.com/watch?v=n9mRjkQg3VE)ï¼Œå…¶æ¯”è¾ƒäº† Server Sent Eventsã€WebSockets å’Œ Long Polling å‡ ä¸ªæŠ€æœ¯çš„ä¼˜åŠ£ã€‚è¿™ä¸ªæ¼”è®²ä¹Ÿæœ‰ç¯‡å¯¹åº”çš„åšå®¢æ–‡ç« æ¥è¾…åŠ©é˜…è¯» [Using SSE Instead Of WebSockets For Unidirectional Data Flow Over HTTP/2](https://www.smashingmagazine.com/2018/02/sse-websockets-data-flow-http2/#comments-sse-websockets-data-flow-http2)ï¼Œå†…å®¹æœ‰è¶£è€Œä¸”éå¸¸æœ‰å¯å‘æ€§ã€‚æˆ‘çœŸçš„å¾ˆæ¨èå¤§å®¶å»çœ‹ä¸€ä¸‹ã€‚ç„¶è€Œï¼Œå®ƒæ˜¯ 2018 å¹´çš„å†…å®¹ï¼Œä¸€äº›ç»†èŠ‚å¯èƒ½å·²ç»å‘ç”Ÿäº†æ”¹å˜ï¼Œå› æ­¤æˆ‘å†³å®šå†™ä¸‹è¿™ç¯‡æ–‡ç« ã€‚

## 2. WebSockets?

[WebSockets](https://tools.ietf.org/html/rfc6455) å¯ä»¥åœ¨æµè§ˆå™¨å’ŒæœåŠ¡å™¨ä¹‹é—´åˆ›å»º **åŒå‘ä½å»¶è¿Ÿ** çš„é€šä¿¡é€šé“ã€‚

è¿™ä½¿å¾—å®ƒåœ¨æŸäº›åœºæ™¯ä¸­éå¸¸é€‚ç”¨ï¼šæ¯”å¦‚**åŒå‘**é€šä¿¡çš„å¤šäººæ¸¸æˆï¼Œå³æµè§ˆå™¨å’ŒæœåŠ¡å™¨éƒ½ä¼šä¸€ç›´åœ¨é€šé“ä¸Šå‘é€æ¶ˆæ¯ï¼Œéœ€è¦å°†è¿™äº›æ¶ˆæ¯ä»¥è¾ƒ**ä½å»¶è¿Ÿ**è¿›è¡Œä¼ é€’ã€‚

åœ¨ä¸€æ¬¾ç¬¬ä¸€äººç§°å°„å‡»æ¸¸æˆä¸­ï¼Œæµè§ˆå™¨å¯ä»¥æŒç»­åœ°ä¼ è¾“ç©å®¶çš„ä½ç½®ï¼ŒåŒæ—¶ä»æœåŠ¡å™¨æ¥æ”¶æ‰€æœ‰å…¶ä»–ç©å®¶ä½ç½®çš„æ›´æ–°ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬è‚¯å®šå¸Œæœ›è¿™äº›æ¶ˆæ¯èƒ½å¤Ÿä»¥å°½å¯èƒ½èŠ±è´¹å°‘çš„å¼€é”€è¿›è¡Œä¼ é€’ï¼Œä»¥é¿å…æ¸¸æˆè¿Ÿç¼“æ„Ÿï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚

è¿™ä¸ä¼ ç»Ÿçš„ [HTTP](https://developer.mozilla.org/en-US/docs/Web/HTTP) [è¯·æ±‚-å“åº”æ¨¡å‹](https://en.wikipedia.org/wiki/Request%E2%80%93response)æ­£å¥½ç›¸åï¼Œå…¶ä¸­æµè§ˆå™¨å§‹ç»ˆæ˜¯å‘èµ·é€šä¿¡çš„ä¸€æ–¹ï¼Œæ¯ä¸ªæ¶ˆæ¯éƒ½å…·æœ‰æ˜¾è‘—çš„å¼€é”€ï¼Œå› ä¸ºè¦å»ºç«‹ [TCP è¿æ¥](https://en.wikipedia.org/wiki/Transmission_Control_Protocol)å’Œä¼ è¾“ [HTTP å¤´éƒ¨](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers)ä¿¡æ¯ã€‚

ç„¶è€Œï¼Œè®¸å¤šåº”ç”¨ç¨‹åºçš„å®ç°ä¸éœ€è¦è¿™ä¹ˆä¸¥æ ¼çš„è¦æ±‚ã€‚å³ä½¿åœ¨å®æ—¶åº”ç”¨ç¨‹åºä¸­ï¼Œ**æ•°æ®æµä¹Ÿé€šå¸¸æ˜¯ä¸å¯¹ç§°çš„**ï¼šæœåŠ¡å™¨å‘é€äº†å¤§éƒ¨åˆ†çš„æ¶ˆæ¯ï¼Œè€Œå®¢æˆ·ç«¯å¤§å¤šåªæ˜¯è´Ÿè´£ç›‘å¬ï¼Œå¹¶ä¸”åªæ˜¯å¶å°”å‘é€ä¸€äº›æ›´æ–°ã€‚ä¾‹å¦‚ï¼Œåœ¨å®æ—¶çš„èŠå¤©åº”ç”¨ç¨‹åºä¸­ï¼Œç”¨æˆ·å¯èƒ½ä¼šè¿æ¥åˆ°è®¸å¤šèŠå¤©æˆ¿é—´ï¼Œæ¯ä¸ªæˆ¿é—´éƒ½æœ‰å‡ åä¸ªæˆ–å‡ ç™¾ä¸ªå‚ä¸è€…ã€‚å› æ­¤ï¼Œæ¥æ”¶åˆ°çš„æ¶ˆæ¯æ•°é‡è¿œè¿œè¶…è¿‡å‘é€çš„æ¶ˆæ¯æ•°é‡ã€‚

## 3. WebSockets çš„é—®é¢˜åœ¨äºå“ªé‡Œ

åŒå‘çš„é€šä¿¡é€šé“å’Œä½å»¶è¿Ÿæ˜¯éå¸¸å¥½çš„åŠŸèƒ½ç‰¹æ€§ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬ä¸ºä»€ä¹ˆè¿˜è¦ç»§ç»­å¯»æ‰¾å…¶ä»–è§£å†³æ–¹æ¡ˆå‘¢ï¼Ÿ

WebSockets æœ‰ä¸€ä¸ªä¸»è¦ç¼ºç‚¹ï¼š**å®ƒä»¬ä¸å®Œå…¨åŸºäº HTTP å·¥ä½œ**ã€‚å®ƒä»¬éœ€è¦è‡ªå·±çš„ TCP è¿æ¥ã€‚å®ƒä»¬åªéœ€è¦ä½¿ç”¨ HTTP å»ºç«‹è¿æ¥ï¼Œç„¶åå°†å…¶å‡çº§ä¸ºä¸€ä¸ªç‹¬ç«‹çš„ TCP è¿æ¥ï¼Œåœ¨å…¶ä¸Šå¯ä»¥ä½¿ç”¨ WebSocket åè®®ã€‚

è¿™å¯èƒ½çœ‹èµ·æ¥ä¸æ˜¯å¾ˆé‡è¦ï¼Œä½†è¿™æ„å‘³ç€ WebSockets ä¸èƒ½ä»ä»»ä½•å·²æœ‰çš„ HTTP ç‰¹æ€§ä¸­å—ç›Šã€‚å³ï¼š

- ä¸æ”¯æŒå‹ç¼©
- ä¸æ”¯æŒ HTTP/2 çš„å¤šè·¯å¤ç”¨
- å¯èƒ½å­˜åœ¨ä»£ç†é—®é¢˜
- æ— è·¨ç«™ç‚¹åŠ«æŒä¿æŠ¤

è‡³å°‘ï¼Œåœ¨ WebSocket åè®®é¦–æ¬¡å‘å¸ƒæ—¶æ˜¯è¿™ç§æƒ…å†µã€‚ç°åœ¨ï¼Œæœ‰ä¸€äº›è¡¥å……æ ‡å‡†è¯•å›¾æ”¹å–„è¿™ç§æƒ…å†µã€‚è®©æˆ‘ä»¬æ›´è¯¦ç»†åœ°äº†è§£å½“å‰çš„æƒ…å†µã€‚

æ³¨æ„ï¼šå¦‚æœæ‚¨ä¸å…³å¿ƒç»†èŠ‚ï¼Œè¯·éšæ„è·³è¿‡æœ¬èŠ‚å…¶ä½™éƒ¨åˆ†ï¼Œç›´æ¥è½¬åˆ° Server-Sent Events æˆ– demo éƒ¨åˆ†ã€‚

### 3.1 å‹ç¼© (Compression)

åœ¨æ ‡å‡†çš„è¿æ¥ä¸Šï¼Œæ¯ä¸ªæµè§ˆå™¨éƒ½æ”¯æŒ [HTTP å‹ç¼©æŠ€æœ¯](https://en.wikipedia.org/wiki/HTTP_compression)ï¼Œåœ¨æœåŠ¡å™¨ç«¯å¯ç”¨ä¹Ÿéå¸¸å®¹æ˜“ï¼Œåªéœ€åœ¨æ‰€é€‰æ‹©çš„åå‘ä»£ç†ä¸­å¼€å¯åˆ‡æ¢ä¸€ä¸‹å¼€å…³ã€‚ä½†æ˜¯ï¼Œå¯¹äºä½¿ç”¨ WebSockets çš„æƒ…å†µè¿™æ›´åŠ å¤æ‚ï¼Œå› ä¸ºæ²¡æœ‰è¯·æ±‚å’Œå“åº”ï¼Œéœ€è¦å‹ç¼©å„ä¸ªç‹¬ç«‹çš„ WebSocket å¸§ (frames)ã€‚

[RFC 7692](https://tools.ietf.org/html/rfc7692)ï¼Œäº 2015 å¹´ 12 æœˆå‘å¸ƒï¼Œè¯•å›¾é€šè¿‡å®šä¹‰ â€œWebSocket å‹ç¼©æ‰©å±•â€ æ¥æ”¹å–„è¿™ç§æƒ…å†µã€‚ç„¶è€Œï¼Œæ®æˆ‘æ‰€çŸ¥ï¼Œæ²¡æœ‰ä»»ä½•æµè¡Œçš„åå‘ä»£ç†æœåŠ¡ï¼ˆå¦‚ nginxã€caddyï¼‰å®ç°äº†è¿™ä¸€åŠŸèƒ½ï¼Œå› æ­¤æ— æ³•é€æ˜åœ°å¯ç”¨å‹ç¼©ã€‚

è¿™æ„å‘³ç€ï¼Œå¦‚æœè¦ä½¿ç”¨å‹ç¼©ï¼Œåˆ™å¿…é¡»åœ¨åç«¯ç›´æ¥å®ç°ã€‚å¹¸è¿çš„æ˜¯ï¼Œæˆ‘æ‰¾åˆ°äº†ä¸€äº›æ”¯æŒ RFC 7692 çš„åº“ã€‚ä¾‹å¦‚ï¼ŒPython çš„ [websockets](https://websockets.readthedocs.io/en/stable/extensions.html) å’Œ [wsproto](https://github.com/python-hyper/wsproto/) åº“ï¼Œä»¥åŠ nodejs çš„ [ws](https://github.com/websockets/ws) åº“ã€‚

ç„¶è€Œï¼Œåè€…å¹¶ä¸å»ºè®®ä½¿ç”¨è¯¥åŠŸèƒ½ï¼š

>è¯¥æ‰©å±•åœ¨æœåŠ¡å™¨ä¸Šé»˜è®¤ç¦ç”¨ï¼Œåœ¨å®¢æˆ·ç«¯ä¸Šé»˜è®¤å¯ç”¨ã€‚å®ƒåœ¨æ€§èƒ½å’Œå†…å­˜æ¶ˆè€—æ–¹é¢å¢åŠ äº†æ˜¾è‘—çš„å¼€é”€ï¼Œå› æ­¤æˆ‘ä»¬å»ºè®®åªåœ¨ç¡®å®éœ€è¦æ—¶æ‰å¯ç”¨å®ƒã€‚
>
>è¯·æ³¨æ„ï¼ŒNode.js åœ¨é«˜æ€§èƒ½å‹ç¼©æ–¹é¢å­˜åœ¨å„ç§é—®é¢˜ï¼Œå°¤å…¶æ˜¯åœ¨ Linux ä¸Šå¢åŠ å¹¶å‘æ€§å¯èƒ½ä¼šå¯¼è‡´ç¾éš¾æ€§çš„å†…å­˜ç¢ç‰‡å’Œæ€§èƒ½ä¸‹é™ã€‚

åœ¨æµè§ˆå™¨æ–¹é¢ï¼ŒFirefox ä»[ 37 ç‰ˆæœ¬](https://developer.mozilla.org/en-US/docs/Mozilla/Firefox/Releases/37#networking)å¼€å§‹æ”¯æŒ WebSocket çš„å‹ç¼©ã€‚[Chrome ä¹Ÿæ”¯æŒ](https://chromestatus.com/feature/6555138000945152)ã€‚ç„¶è€Œï¼Œæ˜¾ç„¶ Safari å’Œ Edge ä¸æ”¯æŒã€‚

æˆ‘æ²¡æœ‰éªŒè¯ç§»åŠ¨è®¾å¤‡ä¸Šçš„æ”¯æŒæƒ…å†µå¦‚ä½•ã€‚

### 3.2 å¤šè·¯å¤ç”¨ (Multiplexing)

[HTTP/2](https://tools.ietf.org/html/rfc7540) å¼•å…¥äº†å¯¹å¤šè·¯å¤ç”¨çš„æ”¯æŒï¼Œæ„å‘³ç€å‘åŒä¸€ä¸»æœºå‘é€çš„å¤šä¸ªè¯·æ±‚/å“åº”å¯¹ä¸å†éœ€è¦å•ç‹¬çš„ TCP è¿æ¥ã€‚ç›¸åï¼Œå®ƒä»¬å¯ä»¥å…±äº«åŒä¸€ä¸ª TCP è¿æ¥ï¼Œæ¯ä¸ªè¯·æ±‚åœ¨å…¶è‡ªå·±ç‹¬ç«‹çš„ [HTTP/2 æµ](https://tools.ietf.org/html/rfc7540#section-5)ä¸Šè¿è¡Œã€‚

è¿™ä¹Ÿå¾—åˆ°äº†[æ¯ä¸ªæµè§ˆå™¨çš„æ”¯æŒ](https://caniuse.com/http2)ï¼Œè€Œä¸”åœ¨å¤§å¤šæ•°åå‘ä»£ç†ä¸Šå¯ç”¨å®ƒä¹Ÿéå¸¸å®¹æ˜“ã€‚

ç›¸æ¯”ä¹‹ä¸‹ï¼ŒWebSocket åè®®é»˜è®¤ä¸æ”¯æŒå¤šè·¯å¤ç”¨ã€‚å‘åŒä¸€ä¸»æœºå‘é€å¤šä¸ª WebSocket å°†å„è‡ªæ‰“å¼€è‡ªå·±çš„ç‹¬ç«‹çš„ TCP è¿æ¥ã€‚å¦‚æœè¦ä½¿ä¸¤ä¸ªç‹¬ç«‹çš„ WebSocket ç»ˆç«¯å…±äº«å®ƒä»¬çš„åŸºç¡€è¿æ¥ï¼Œæ‚¨å¿…é¡»è‡ªå·±åœ¨åº”ç”¨ç¨‹åºä»£ç ä¸­æ·»åŠ å¤šè·¯å¤ç”¨èƒ½åŠ›æ”¯æŒã€‚

[RFC 8441](https://tools.ietf.org/html/rfc8441) äº 2018 å¹´ 9 æœˆå‘å¸ƒï¼Œå°è¯•é€šè¿‡æ·»åŠ â€œä½¿ç”¨ HTTP/2 å¼•å¯¼ WebSocketâ€çš„æ”¯æŒæ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚å®ƒå·²åœ¨ [Firefox](https://bugzilla.mozilla.org/show_bug.cgi?id=1434137) å’Œ [Chrome](https://chromestatus.com/feature/6251293127475200) ä¸­å®ç°ã€‚ç„¶è€Œï¼Œæ®æˆ‘æ‰€çŸ¥ï¼Œæ²¡æœ‰ä¸»è¦çš„åå‘ä»£ç†æœåŠ¡å®ç°äº†å®ƒã€‚ä¸å¹¸çš„æ˜¯ï¼Œæˆ‘ä¹Ÿæ‰¾ä¸åˆ° Python æˆ– Javascript çš„ä»»ä½•å®ç°ã€‚

### 3.3 ä»£ç†é—®é¢˜ (Issues with proxies)

æ²¡æœ‰æ˜¾å¼æ”¯æŒ WebSockets çš„ HTTP ä»£ç†å¯èƒ½ä¼šé˜»æ­¢æœªåŠ å¯†çš„ WebSocket è¿æ¥æ­£å¸¸å·¥ä½œã€‚è¿™æ˜¯å› ä¸ºä»£ç†æ— æ³•è§£æ WebSocket å¸§ (frames) å¹¶å…³é—­è¿æ¥ã€‚

ä½†æ˜¯ï¼Œé€šè¿‡ HTTPS å‘èµ·çš„ WebSocket è¿æ¥åº”è¯¥ä¸å—æ­¤é—®é¢˜çš„å½±å“ï¼Œå› ä¸ºå¸§å°†è¢«åŠ å¯†ï¼Œä»£ç†åº”è¯¥åªæ˜¯è½¬å‘æ‰€æœ‰å†…å®¹è€Œä¸ä¼šå…³é—­è¿æ¥ã€‚

è¦äº†è§£æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§ Peter Lubbers çš„â€œ[HTML5 Web Sockets å¦‚ä½•ä¸ä»£ç†æœåŠ¡å™¨äº¤äº’](https://www.infoq.com/articles/Web-Sockets-Proxy-Servers/)â€ã€‚

### 3.4 è·¨ç«™ WebSocket åŠ«æŒ

WebSocket è¿æ¥æ²¡æœ‰å—åˆ°åŒæºç­–ç•¥çš„ä¿æŠ¤ï¼Œè¿™ä½¿å®ƒä»¬å®¹æ˜“å—åˆ°è·¨ç«™ WebSocket åŠ«æŒæ”»å‡»ã€‚

å› æ­¤ï¼Œ**å¦‚æœ WebSocket åç«¯æ²¡æœ‰ä½¿ç”¨ä»»ä½•å®¢æˆ·ç«¯ç¼“å­˜çš„èº«ä»½éªŒè¯æ–¹å¼ï¼ˆä¾‹å¦‚ cookieæˆ– HTTP èº«ä»½éªŒè¯ï¼‰ï¼Œå®ƒä»¬å¿…é¡»æ£€æŸ¥ Origin å¤´çš„æ­£ç¡®æ€§**ã€‚

æˆ‘åœ¨è¿™é‡Œä¸ä¼šè¯¦ç»†è®¨è®ºï¼Œä½†æ˜¯è¯·è€ƒè™‘è¿™ä¸ªç®€çŸ­çš„ä¾‹å­ã€‚å‡è®¾ä¸€ä¸ªæ¯”ç‰¹å¸äº¤æ˜“æ‰€ä½¿ç”¨ WebSockets æä¾›å…¶äº¤æ˜“æœåŠ¡ã€‚å½“æ‚¨ç™»å½•æ—¶ï¼Œäº¤æ˜“æ‰€å¯èƒ½è®¾ç½®ä¸€ä¸ª cookie æ¥ä¿æŒæ‚¨çš„ä¼šè¯åœ¨ä¸€å®šæ—¶é—´å†…æ´»åŠ¨ã€‚ç°åœ¨ï¼Œæ”»å‡»è€…è¦å·å–ä½ çè´µçš„æ¯”ç‰¹å¸æ‰€è¦åšçš„å°±æ˜¯è®©ä½ è®¿é—®å¥¹æ§åˆ¶çš„ç«™ç‚¹ï¼Œç„¶åç®€å•åœ°æ‰“å¼€ä¸€ä¸ª WebSocket è¿æ¥åˆ°äº¤æ˜“æ‰€ã€‚æ¶æ„è¿æ¥å°†è¢«è‡ªåŠ¨éªŒè¯ï¼Œé™¤éäº¤æ˜“æ‰€æ£€æŸ¥ **Origin** å¤´å¹¶é˜»æ­¢æ¥è‡ªæœªæˆæƒåŸŸçš„è¿æ¥ã€‚

æˆ‘å»ºè®®æ‚¨é˜…è¯» Christian Schneider å…³äº[è·¨ç«™ WebSocket åŠ«æŒ](https://christian-schneider.net/CrossSiteWebSocketHijacking.html#main)çš„ç²¾å½©æ–‡ç« ä»¥äº†è§£æ›´å¤šä¿¡æ¯ã€‚

## 4. Server-Sent Events

ç°åœ¨æˆ‘ä»¬å¯¹ WebSockets æœ‰äº†æ›´å¤šçš„äº†è§£ï¼ŒåŒ…æ‹¬å®ƒä»¬çš„ä¼˜ç‚¹å’Œç¼ºç‚¹ï¼Œè®©æˆ‘ä»¬å­¦ä¹ ä¸€ä¸‹ Server-Sent Events å¹¶äº†è§£å®ƒä»¬æ˜¯å¦æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„æ›¿ä»£æ–¹æ¡ˆã€‚

[Server-Sent Events](https://html.spec.whatwg.org/#server-sent-events) ä½¿æœåŠ¡å™¨èƒ½å¤Ÿéšæ—¶å‘å®¢æˆ·ç«¯å‘é€ä½å»¶è¿Ÿçš„æ¨é€äº‹ä»¶ã€‚å®ƒä»¬ä½¿ç”¨éå¸¸ç®€å•çš„åè®®ï¼Œå¹¶ä¸”æ˜¯ [HTML æ ‡å‡†](https://html.spec.whatwg.org/#server-sent-events)çš„ä¸€éƒ¨åˆ†ï¼Œå—åˆ°[æ¯ä¸ªæµè§ˆå™¨çš„æ”¯æŒ](https://html.spec.whatwg.org/#server-sent-events)ã€‚

ä¸ WebSockets ä¸åŒï¼Œ**Server-Sent Events ä»…æ”¯æŒå‘å®¢æˆ·ç«¯å•å‘ä¿¡æ¯æµåŠ¨**ã€‚è¿™ä½¿å¾—å®ƒä»¬ä¸é€‚åˆä¸€äº›éœ€è¦å¤„ç†ç‰¹å®šåœºæ™¯çš„åº”ç”¨ç¨‹åºï¼Œå³é‚£äº›éœ€è¦æ—¢æ˜¯åŒå‘åˆæ˜¯ä½å»¶è¿Ÿçš„é€šä¿¡é€šé“ï¼Œæ¯”å¦‚å®æ—¶æ¸¸æˆã€‚ç„¶è€Œï¼Œè¿™äº›æƒè¡¡å–èˆä¹Ÿæ˜¯å®ƒä»¬ç›¸å¯¹äº WebSockets çš„ä¸»è¦ä¼˜åŠ¿ï¼Œå› ä¸ºå•å‘æµåŠ¨ä½¿å¾— **Server-Sent Events å¯ä»¥åœ¨ HTTP ä¹‹ä¸Šæ— ç¼çš„å·¥ä½œï¼Œè€Œæ— éœ€è‡ªå®šä¹‰åè®®**ã€‚è¿™ä½¿å®ƒä»¬è‡ªåŠ¨è·å¾—äº†æ‰€æœ‰ HTTP çš„åŠŸèƒ½ï¼Œä¾‹å¦‚å‹ç¼©æˆ– HTTP/2 å¤šè·¯å¤ç”¨èƒ½åŠ›ï¼Œä½¿å®ƒä»¬æˆä¸ºå¤§å¤šæ•°å®æ—¶åº”ç”¨ç¨‹åºçš„éå¸¸æ–¹ä¾¿çš„é€‰æ‹©ï¼Œå…¶ä¸­å¤§éƒ¨åˆ†æ•°æ®éƒ½æ¥è‡ªæœåŠ¡å™¨ï¼Œå¹¶ä¸”ç”±äº HTTP å¤´éƒ¨çš„ä¸€äº›å¼€é”€è€Œå¯¼è‡´ä¸€äº›è¯·æ±‚çš„å¼€é”€æ˜¯å¯ä»¥æ¥å—çš„ã€‚

åè®®éå¸¸ç®€å•ã€‚å®ƒä½¿ç”¨ `text/event-stream` ä½œä¸ºå†…å®¹ç±»å‹ (Content-Type) å’Œæ¶ˆæ¯çš„å½¢å¼å¦‚ä¸‹ï¼š

```text
data: First message

event: join
data: Second message. It has two
data: lines, a custom event type and an id.
id: 5

: comment. Can be used as keep-alive

data: Third message. I do not have more data.
data: Please retry later.
retry: 10
```

æ¯ä¸ªäº‹ä»¶ç”±ä¸¤ä¸ªæ¢è¡Œç¬¦ï¼ˆ\nï¼‰åˆ†éš”ï¼Œå¹¶ç”±å¤šä¸ªå¯é€‰å­—æ®µç»„æˆã€‚

å¯é‡å¤ä½¿ç”¨åœ¨å¤šå¤„å‡ºç°çš„å­—æ®µ `data` é€šå¸¸ç”¨äºè¡¨ç¤ºäº‹ä»¶æ•°æ®çš„å†…å®¹ã€‚

å­—æ®µ `event` å…è®¸æŒ‡å®šè‡ªå®šä¹‰äº‹ä»¶ç±»å‹ï¼Œå¦‚ä¸‹ä¸€èŠ‚æ‰€ç¤ºï¼Œå®ƒå¯ä»¥ç”¨äºåœ¨å®¢æˆ·ç«¯ä¸Šè§¦å‘ä¸åŒçš„äº‹ä»¶å¤„ç†ç¨‹åºã€‚

å¦å¤–ä¸¤ä¸ªå­—æ®µ `id` å’Œ `retry` ç”¨äºé…ç½®è‡ªåŠ¨é‡è¿æœºåˆ¶çš„è¡Œä¸ºã€‚è¿™æ˜¯ `Server-Sent Events` æœ€æœ‰è¶£çš„ç‰¹æ€§ä¹‹ä¸€ã€‚å®ƒç¡®ä¿åœ¨è¿æ¥æ–­å¼€æˆ–è¢«æœåŠ¡å™¨å…³é—­æ—¶ï¼Œæ— éœ€ç”¨æˆ·å¹²é¢„ï¼Œå®¢æˆ·ç«¯å°†è‡ªåŠ¨å°è¯•é‡æ–°è¿æ¥ã€‚

`retry` å­—æ®µç”¨äºæŒ‡å®šåœ¨å°è¯•é‡æ–°è¿æ¥ä¹‹å‰ç­‰å¾…çš„æœ€çŸ­æ—¶é—´ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ã€‚å½“æœåŠ¡å™¨è¿æ¥äº†å¤ªå¤šå®¢æˆ·ç«¯æ—¶ï¼Œå®ƒä¹Ÿå¯ä»¥åœ¨ç«‹å³å…³é—­å®¢æˆ·ç«¯è¿æ¥ä¹‹å‰å‘é€è¯¥å­—æ®µä»¥å‡è½»å…¶è´Ÿè½½ã€‚

`id` å­—æ®µå°†æ ‡è¯†ç¬¦ä¸å½“å‰äº‹ä»¶ç›¸å…³è”ã€‚åœ¨é‡æ–°è¿æ¥æ—¶ï¼Œå®¢æˆ·ç«¯å°†ä½¿ç”¨ `Last-Event-ID` HTTP è¯·æ±‚å¤´å°†ä¸Šæ¬¡çœ‹åˆ°çš„ id ä¼ è¾“ç»™æœåŠ¡å™¨ã€‚è¿™ä½¿å¾—æˆ‘ä»¬å¯ä»¥ä»æ­£ç¡®çš„å¤±æ•ˆç‚¹æ¢å¤é€šè®¯æµã€‚

æœ€åï¼ŒæœåŠ¡å™¨å¯ä»¥é€šè¿‡è¿”å› [HTTP 204 No Content](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/204) å“åº”æ¥å®Œå…¨åœæ­¢è‡ªåŠ¨é‡è¿æœºåˆ¶ã€‚

## 5. æ¥ç‚¹å®é™…ä»£ç  Demo

ç°åœ¨ï¼Œè®©æˆ‘ä»¬å°†æ‰€å­¦çš„å†…å®¹ä»˜è¯¸å®è·µã€‚åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ Server-Sent Events å’Œ WebSockets å®ç°ä¸€ä¸ªç®€å•çš„æœåŠ¡ã€‚è¿™å°†ä½¿æˆ‘ä»¬èƒ½å¤Ÿå®é™…æ¯”è¾ƒè¿™ä¸¤ç§æŠ€æœ¯ã€‚æˆ‘ä»¬å°†äº†è§£åˆ°ä½¿ç”¨æ¯ç§æŠ€æœ¯å¼€å§‹çš„éš¾æ˜“ç¨‹åº¦ï¼Œå¹¶æ‰‹åŠ¨éªŒè¯å‰é¢è®¨è®ºçš„åŠŸèƒ½ã€‚

æˆ‘ä»¬å°†ä½¿ç”¨ Python ä½œä¸ºåç«¯ï¼ŒCaddy ä½œä¸ºåå‘ä»£ç†ï¼Œå½“ç„¶è¿˜éœ€è¦ä¸€äº› JavaScript ä»£ç ç”¨äºå‰ç«¯ã€‚

ä¸ºäº†è®©æˆ‘ä»¬çš„ç¤ºä¾‹å°½å¯èƒ½ç®€å•ï¼Œæˆ‘ä»¬çš„åç«¯å°†åªåŒ…å«ä¸¤ä¸ªç«¯ç‚¹ (endpoints)ï¼Œæ¯ä¸ªç«¯ç‚¹éƒ½ä¼šæµå¼ä¼ è¾“å”¯ä¸€çš„éšæœºæ•°å­—åºåˆ—ã€‚ä» /sse1 å’Œ /sse2 è¿›è¡Œ Server-Sent Events è®¿é—®ï¼Œä» /ws1 å’Œ /ws2 è¿›è¡Œ WebSockets çš„è®¿é—®ã€‚æˆ‘ä»¬çš„å‰ç«¯å°†ä»…ç”±ä¸€ä¸ª index.html æ–‡ä»¶ç»„æˆï¼Œå…¶ä¸­åŒ…å«ä¸€äº› JavaScript ä»£ç ï¼Œå¯ä»¥è®©æˆ‘ä»¬å¯åŠ¨å’Œåœæ­¢ WebSockets å’Œ Server-Sent Events è¿æ¥ã€‚

[ç¤ºä¾‹ä»£ç  - GitHub](https://github.com/tyrion/sse-websockets-demo)

### 5.1 åå‘ä»£ç†

ä½¿ç”¨åå‘ä»£ç†ï¼Œä¾‹å¦‚ Caddy æˆ– nginxï¼Œå¯¹äºè¿™ç§å°ä¾‹å­ä¸­éå¸¸æœ‰ç”¨ã€‚å®ƒè®©æˆ‘ä»¬å¾ˆå®¹æ˜“åœ°å¼€å¯å¾ˆå¤šæˆ‘ä»¬æ‰€é€‰æ‹©çš„åç«¯å¯èƒ½ç¼ºå°‘çš„åŠŸèƒ½ã€‚

æ›´å…·ä½“åœ°è¯´ï¼Œå®ƒå…è®¸æˆ‘ä»¬è½»æ¾åœ°æä¾›é™æ€æ–‡ä»¶å¹¶è‡ªåŠ¨å‹ç¼© HTTP å“åº”ï¼›æä¾› HTTP/2 æ”¯æŒï¼Œå³ä½¿æˆ‘ä»¬çš„åç«¯ä»…æ”¯æŒ HTTP/1ï¼Œä¹Ÿå¯ä»¥è®©æˆ‘ä»¬å—ç›Šäºå¤šè·¯å¤ç”¨ï¼›æœ€åè¿˜å¯ä»¥è¿›è¡Œè´Ÿè½½å‡è¡¡ã€‚

æˆ‘é€‰æ‹©äº†Caddyï¼Œå› ä¸ºå®ƒå¯ä»¥è‡ªåŠ¨ä¸ºæˆ‘ä»¬ç®¡ç†HTTPSè¯ä¹¦ï¼Œè®©æˆ‘ä»¬è·³è¿‡ä¸€ä¸ªéå¸¸ä¹å‘³çš„ä»»åŠ¡ï¼Œå°¤å…¶æ˜¯å¯¹äºä¸€ä¸ªå¿«é€Ÿå®éªŒ Demoã€‚

åŸºæœ¬é…ç½®ä½äºé¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ `Caddyfile` ä¸­ï¼Œå¤§è‡´å¦‚ä¸‹ï¼š

```text
localhost

bind 127.0.0.1 ::1

root ./static
file_server browse

encode zstd gzip
```

è¿™æŒ‡ç¤º Caddy ç›‘å¬æœ¬åœ°æ¥å£çš„ 80 å’Œ 443 ç«¯å£ï¼Œå¯ç”¨ HTTPS æ”¯æŒå¹¶ç”Ÿæˆè‡ªç­¾åè¯ä¹¦ã€‚å®ƒè¿˜æ”¯æŒå‹ç¼©å’Œæä¾›è®¿é—® `static` ç›®å½•ä¸‹çš„é™æ€æ–‡ä»¶ã€‚

æœ€åä¸€æ­¥ï¼Œæˆ‘ä»¬éœ€è¦è®© Caddy ä»£ç†åˆ°æˆ‘ä»¬çš„åç«¯æœåŠ¡ã€‚Server-Sent Eventsåªæ˜¯æ™®é€šçš„HTTPè¯·æ±‚ï¼Œæ‰€ä»¥è¿™é‡Œæ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„:

```text
reverse_proxy /sse1 127.0.1.1:6001
reverse_proxy /sse2 127.0.1.1:6002
```

è¦ä»£ç† Websocketï¼Œéœ€è¦åå‘ä»£ç†æ˜¾å¼æ”¯æŒã€‚å¹¸è¿çš„æ˜¯ï¼ŒCaddy å¯ä»¥æ¯«æ— éšœç¢åœ°å¤„ç†è¿™ä¸ªé—®é¢˜ï¼Œå°½ç®¡é…ç½®æœ‰ç‚¹å†—é•¿:

```text
@websockets {
    header Connection *Upgrade*
    header Upgrade    websocket
}

handle /ws1 {
    reverse_proxy @websockets 127.0.1.1:6001
}

handle /ws2 {
    reverse_proxy @websockets 127.0.1.1:6002
}
```

æœ€åä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å¯åŠ¨ Caddy:

```shell
sudo caddy start
```

### 5.2 å‰ç«¯

è®©æˆ‘ä»¬ä»å‰ç«¯å¼€å§‹ï¼Œæ¯”è¾ƒ WebSockets å’Œ Server-Sent Events çš„ JavaScript APIã€‚

WebSocket çš„JavaScript APIéå¸¸æ˜“äºä½¿ç”¨ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„ WebSocket å¯¹è±¡ï¼Œä¼ é€’æœåŠ¡å™¨çš„ URLã€‚è¿™é‡Œï¼Œ`wss` è¡¨ç¤ºè¿æ¥å°†åœ¨ HTTPS ä¸Šè¿›è¡Œã€‚å¦‚ä¸Šæ‰€è¿°ï¼Œå¼ºçƒˆå»ºè®®ä½¿ç”¨ HTTPS ä»¥é¿å…ä»£ç†é—®é¢˜ã€‚

ç„¶åï¼Œæˆ‘ä»¬åº”è¯¥ç›‘å¬ä¸€äº›å¯èƒ½çš„äº‹ä»¶ï¼ˆå³æ‰“å¼€ `open`ã€æ¶ˆæ¯ `message`ã€å…³é—­ `close`ã€é”™è¯¯ `error`ï¼‰ï¼Œé€šè¿‡è®¾ç½® `on$event` å±æ€§æˆ–ä½¿ç”¨ `addEventListener()`ã€‚

```js
const ws = new WebSocket("wss://localhost/ws");

ws.onopen = e => console.log("WebSocket open");

ws.addEventListener(
  "message", e => console.log(e.data));
```

JavaScript çš„ Server-Sent Events API éå¸¸ç±»ä¼¼ã€‚å®ƒè¦æ±‚æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„ EventSource å¯¹è±¡ï¼Œä¼ é€’æœåŠ¡å™¨çš„ URLï¼Œç„¶åå¯ä»¥é€šè¿‡ç›¸åŒçš„æ–¹å¼è®¢é˜…äº‹ä»¶ã€‚

ä¸»è¦çš„åŒºåˆ«åœ¨äºï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è®¢é˜…è‡ªå®šä¹‰äº‹ä»¶ã€‚

```js
const es = new EventSource("https://localhost/sse");

es.onopen = e => console.log("EventSource open");

es.addEventListener(
  "message", e => console.log(e.data));

// Event listener for custom event
// è®¢é˜…è‡ªå®šä¹‰äº‹ä»¶
es.addEventListener(
  "join", e => console.log(`${e.data} joined`))
```

æˆ‘ä»¬ç°åœ¨å¯ä»¥ä½¿ç”¨æ‰€æœ‰è¿™äº›å…³äº JS APIs çš„æ–°çŸ¥è¯†æ¥æ„å»ºæˆ‘ä»¬å®é™…çš„å‰ç«¯ã€‚

ä¸ºäº†è®©äº‹æƒ…å°½å¯èƒ½ç®€å•ï¼Œå®ƒåªåŒ…å«ä¸€ä¸ª index.html æ–‡ä»¶ï¼Œé‡Œé¢æœ‰ä¸€å †ç”¨æ¥å¯åŠ¨å’Œåœæ­¢ WebSockets å’Œ EventSources çš„æŒ‰é’®ã€‚åƒè¿™æ ·ï¼š

```html
<button onclick="startWS(1)">Start WS1</button>
<button onclick="closeWS(1)">Close WS1</button>
<br>
<button onclick="startWS(2)">Start WS2</button>
<button onclick="closeWS(2)">Close WS2</button>
```

æˆ‘ä»¬éœ€è¦å¤šä¸ª WebSocket/EventSourceï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æµ‹è¯• HTTP/2 å¤šè·¯å¤ç”¨æ˜¯å¦æœ‰æ•ˆä»¥åŠæ‰“å¼€äº†å¤šå°‘è¿æ¥ã€‚

ç°åœ¨è®©æˆ‘ä»¬å®ç°è¿™äº›æŒ‰é’®å·¥ä½œæ‰€éœ€çš„ä¸¤ä¸ªå‡½æ•°:

```js
const wss = [];

function startWS(i) {
  if (wss[i] !== undefined) return;

  const ws = wss[i] = new WebSocket("wss://localhost/ws"+i);
  ws.onopen = e => console.log("WS open");
  ws.onmessage = e => console.log(e.data);
  ws.onclose = e => closeWS(i);
}

function closeWS(i) {
  if (wss[i] !== undefined) {
    console.log("Closing websocket");
    websockets[i].close();
    delete websockets[i];
  }
}
```

Server-Sent Events çš„å‰ç«¯ä»£ç å‡ ä¹ç›¸åŒã€‚å”¯ä¸€çš„åŒºåˆ«æ˜¯ `onerror` äº‹ä»¶å¤„ç†ç¨‹åºï¼Œå®ƒä¹‹æ‰€ä»¥å­˜åœ¨ï¼Œæ˜¯å› ä¸ºä¸€æ—¦å‘ç”Ÿé”™è¯¯ï¼Œæµè§ˆå™¨å°±ä¼šè®°å½•ä¸€æ¡æ¶ˆæ¯ï¼Œå¹¶å°è¯•è¿›è¡Œé‡è¿ã€‚

```js
const ess = [];

function startES(i) {
  if (ess[i] !== undefined) return;

  const es = ess[i] = new EventSource("https://localhost/sse"+i);
  es.onopen = e => console.log("ES open");
  es.onerror = e => console.log("ES error", e);
  es.onmessage = e => console.log(e.data);
}

function closeES(i) {
  if (ess[i] !== undefined) {
    console.log("Closing EventSource");
    ess[i].close()
    delete ess[i]
  }
}
```

### 5.3 åç«¯

ç°åœ¨æˆ‘ä»¬æ¥ç¼–å†™åç«¯ä»£ç ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ Python çš„å¼‚æ­¥ Web æ¡†æ¶ [Starlette](https://www.starlette.io/)ï¼Œä½¿ç”¨ [Uvicorn](https://www.uvicorn.org/) ä½œä¸ºæœåŠ¡å™¨ã€‚ä¸ºäº†ä½¿äº‹æƒ…æ¨¡å—åŒ–ï¼Œæˆ‘ä»¬å°†åˆ†ç¦»æ•°æ®ç”Ÿæˆè¿‡ç¨‹å’Œç«¯ç‚¹ (endpoints) çš„å®ç°ã€‚

æˆ‘ä»¬å¸Œæœ›ä¸¤ä¸ªç«¯ç‚¹ä¸­çš„æ¯ä¸€ä¸ªéƒ½ç”Ÿæˆä¸€ç³»åˆ—å”¯ä¸€çš„éšæœºæ•°ã€‚ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨æµ IDï¼ˆå³1æˆ–2ï¼‰ä½œä¸º[éšæœºç§å­ (random seed)](https://en.wikipedia.org/wiki/Random_seed)çš„ä¸€éƒ¨åˆ†ã€‚

ç†æƒ³æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¹Ÿå¸Œæœ›æˆ‘ä»¬çš„æµæ˜¯å¯æ¢å¤çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœè¿æ¥ä¸­æ–­ï¼Œå®¢æˆ·ç«¯åº”è¯¥èƒ½å¤Ÿä»å®ƒæ”¶åˆ°çš„æœ€åä¸€æ¡æ¶ˆæ¯æ¢å¤æµï¼Œè€Œä¸æ˜¯é‡æ–°è¯»å–æ•´ä¸ªåºåˆ—ã€‚ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å°†ä¸ºæ¯ä¸ªæ¶ˆæ¯/äº‹ä»¶åˆ†é…ä¸€ä¸ª IDï¼Œå¹¶åœ¨ç”Ÿæˆæ¯ä¸ªæ¶ˆæ¯ä¹‹å‰ä½¿ç”¨å®ƒæ¥åˆå§‹åŒ–éšæœºç§å­ï¼Œä»¥åŠæµ IDã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼ŒID å°†åªæ˜¯ä» 0 å¼€å§‹çš„è®¡æ•°å™¨ (Counter)ã€‚

æœ‰äº†è¿™äº›ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç¼–å†™ get_data å‡½æ•°æ¥ç”Ÿæˆæˆ‘ä»¬çš„éšæœºæ•°ï¼š

```python
import random

def get_data(stream_id: int, event_id: int) -> int:
    rnd = random.Random()
    rnd.seed(stream_id * event_id)
    return rnd.randrange(1000)
```

ç°åœ¨æˆ‘ä»¬æ¥å†™å‡ºå®é™…çš„ endpointsã€‚

Starlette çš„å…¥é—¨éå¸¸ç®€å•ã€‚æˆ‘ä»¬åªéœ€è¦åˆå§‹åŒ–ä¸€ä¸ªåº”ç”¨ç¨‹åº `app`ï¼Œç„¶åæ³¨å†Œä¸€äº›è·¯ç”±ç»™å®ƒ:

```python
from starlette.applications import Starlette

app = Starlette()
```

ä¸ºäº†ç¼–å†™ WebSocket æœåŠ¡ï¼Œæˆ‘ä»¬é€‰æ‹©çš„ web æœåŠ¡å™¨å’Œæ¡†æ¶éƒ½å¿…é¡»æœ‰æ˜ç¡®çš„æ”¯æŒã€‚å¹¸è¿çš„æ˜¯ï¼ŒUvicorn å’Œ Starlette å¯ä»¥èƒœä»»è¿™ä¸ªä»»åŠ¡ï¼Œç¼–å†™ WebSocket ç«¯ç‚¹ä¸ç¼–å†™æ™®é€šè·¯ç”±ä¸€æ ·æ–¹ä¾¿ã€‚

è¿™å°±æ˜¯æˆ‘ä»¬éœ€è¦çš„æ‰€æœ‰ä»£ç :

```python
from websockets.exceptions import WebSocketException

@app.websocket_route("/ws{id:int}")
async def websocket_endpoint(ws):
    id = ws.path_params["id"]
    try:
        await ws.accept()

        for i in itertools.count():
            data = {"id": i, "msg": get_data(id, i)}
            await ws.send_json(data)
            await asyncio.sleep(1)
    except WebSocketException:
        print("client disconnected")
```

ä¸Šè¿°ä»£ç å°†ç¡®ä¿æ¯å½“æµè§ˆå™¨è¯·æ±‚ä»¥ `/ws` å¼€å¤´å¹¶åè·Ÿä¸€ä¸ªæ•°å­—çš„è·¯å¾„æ—¶ï¼ˆä¾‹å¦‚ `/ws1`ã€`/ws2`ï¼‰ï¼Œå°±ä¼šè°ƒç”¨ websocket_endpoint å‡½æ•°ã€‚

ç„¶åï¼Œå¯¹äºæ¯ä¸ªåŒ¹é…çš„è¯·æ±‚ï¼Œå®ƒå°†ç­‰å¾… WebSocket è¿æ¥å»ºç«‹ï¼Œéšåå¼€å§‹æ— é™å¾ªç¯æ¯ç§’å‘é€éšæœºæ•°å­—ï¼Œç¼–ç ä¸º JSON æœ‰æ•ˆè½½è·ã€‚

å¯¹äº Server-Sent Eventsï¼Œä»£ç éå¸¸ç›¸ä¼¼ï¼Œé™¤äº†ä¸éœ€è¦ä»»ä½•ç‰¹æ®Šçš„æ¡†æ¶æ”¯æŒã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ³¨å†Œä¸€ä¸ªè·¯ç”±ï¼ŒåŒ¹é…ä»¥ /sse å¼€å¤´å¹¶ä»¥æ•°å­—ç»“å°¾çš„ URLï¼ˆä¾‹å¦‚ `/sse1`ã€`/sse2`ï¼‰ã€‚ä½†æ˜¯ï¼Œè¿™æ¬¡æˆ‘ä»¬çš„ç«¯ç‚¹åªæ˜¯è®¾ç½®é€‚å½“çš„æ ‡å¤´å¹¶è¿”å› `StreamingResponse`:

```python
from starlette.responses import StreamingResponse

@app.route("/sse{id:int}")
async def sse_endpoint(req):
    return StreamingResponse(
        sse_generator(req),
        headers={
            "Content-type": "text/event-stream",
            "Cache-Control": "no-cache",
            "Connection": "keep-alive",
        },
    )
```

`StreamingResponse` æ˜¯ `Starlette` æä¾›çš„ä¸€ä¸ªå®ç”¨ç¨‹åºç±»ï¼Œå®ƒæ¥å—ä¸€ä¸ªç”Ÿæˆå™¨ï¼Œå¹¶å°†å…¶è¾“å‡ºæµå¼ä¼ è¾“åˆ°å®¢æˆ·ç«¯ï¼Œä¿æŒè¿æ¥å¤„äºæ‰“å¼€çŠ¶æ€ã€‚

ä¸‹é¢ä¸º `sse_generator` çš„å®ç°ä»£ç ï¼Œå‡ ä¹ä¸ WebSocket ç«¯ç‚¹ç›¸åŒï¼Œåªæ˜¯æ¶ˆæ¯æŒ‰ç…§ Server-Sent Events åè®®è¿›è¡Œç¼–ç ï¼š

```python
async def sse_generator(req):
    id = req.path_params["id"]
    for i in itertools.count():
        data = get_data(id, i)
        data = b"id: %d\ndata: %d\n\n" % (i, data)
        yield data
        await asyncio.sleep(1)
```

æˆ‘ä»¬å®Œæˆäº†!

æœ€åï¼Œå‡è®¾æˆ‘ä»¬å°†æ‰€æœ‰ä»£ç æ”¾åœ¨åä¸º `server.py` çš„æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Uvicorn å¯åŠ¨æˆ‘ä»¬çš„åç«¯ endpointsï¼Œå¦‚ä¸‹æ‰€ç¤º:

```shell
$ uvicorn --host 127.0.1.1 --port 6001 server:app &
$ uvicorn --host 127.0.1.1 --port 6002 server:app &
```

## 6. å½©è›‹: SSE å¾ˆæ£’çš„ç‰¹æ€§

å¥½äº†ï¼Œç°åœ¨è®©æˆ‘ä»¬æ¥æ€»ç»“ä¸€ä¸‹ï¼Œå®ç°æˆ‘ä»¬ä¹‹å‰å¹å˜˜çš„é‚£äº›æ¼‚äº®çš„åŠŸèƒ½æ˜¯å¤šä¹ˆå®¹æ˜“ã€‚

å¯ä»¥é€šè¿‡ä¿®æ”¹ç«¯ç‚¹ä¸­çš„å‡ è¡Œä»£ç æ¥å¯ç”¨å‹ç¼©:

```python
@@ -32,10 +33,12 @@ async def websocket_endpoint(ws):
 
 async def sse_generator(req):
     id = req.path_params["id"]
+    stream = zlib.compressobj()
     for i in itertools.count():
         data = get_data(id, i)
         data = b"id: %d\ndata: %d\n\n" % (i, data)
-        yield data
+        yield stream.compress(data)
+        yield stream.flush(zlib.Z_SYNC_FLUSH)
         await asyncio.sleep(1)
 
 
@@ -47,5 +50,6 @@ async def sse_endpoint(req):
             "Content-type": "text/event-stream",
             "Cache-Control": "no-cache",
             "Connection": "keep-alive",
+            "Content-Encoding": "deflate",
         },
     )
```

ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥æ£€æŸ¥å¼€å‘è€…å·¥å…· (DevTools) æ¥éªŒè¯ä¸€åˆ‡æ˜¯å¦æŒ‰é¢„æœŸå·¥ä½œ:

![Compression](https://s1.ax1x.com/2023/03/11/ppK8x3T.png)

å› ä¸º Cadd yæ”¯æŒ HTTP/2ï¼Œæ‰€ä»¥å¤šè·¯å¤ç”¨æ˜¯é»˜è®¤å¯ç”¨çš„ã€‚æˆ‘ä»¬å¯ä»¥å†æ¬¡ä½¿ç”¨å¼€å‘è€…å·¥å…·æ¥ç¡®è®¤æ‰€æœ‰ SSE è¯·æ±‚éƒ½ä½¿ç”¨åŒä¸€ä¸ªè¿æ¥:

![Multiplexing](https://s1.ax1x.com/2023/03/11/ppKGFER.png)

**è‡ªåŠ¨é‡è¿**: åœ¨å‘ç”Ÿæ„å¤–è¿æ¥é”™è¯¯æ—¶è‡ªåŠ¨é‡æ–°è¿æ¥å¾ˆç®€å•ï¼Œåªéœ€åœ¨åç«¯ä»£ç ä¸­è¯»å– `[Last-Event-ID](https://html.spec.whatwg.org/multipage/server-sent-events.html#last-event-id)` å¤´ä¿¡æ¯:

```python
<     for i in itertools.count():
---
>     start = int(req.headers.get("last-event-id", 0))
>     for i in itertools.count(start):
```

å‰ç«¯ä»£ç ä¸éœ€è¦ä»»ä½•æ”¹åŠ¨ã€‚

æˆ‘ä»¬å¯ä»¥é€šè¿‡å¯åŠ¨åˆ° SSE ç«¯ç‚¹çš„è¿æ¥ï¼Œç„¶åå…³é—­ uvicorn æ¥æµ‹è¯•å®ƒæ˜¯å¦æ­£å¸¸å·¥ä½œã€‚è¿æ¥ä¼šæ–­å¼€ï¼Œä½†æµè§ˆå™¨ä¼šè‡ªåŠ¨å°è¯•é‡æ–°è¿æ¥ã€‚å› æ­¤ï¼Œå¦‚æœé‡æ–°å¯åŠ¨æœåŠ¡å™¨ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°æµä»ä¸­æ–­çš„åœ°æ–¹æ¢å¤!

è¯·æ³¨æ„æµæ˜¯å¦‚ä½•ä»æ¶ˆæ¯ `243` æ¢å¤çš„ã€‚æ„Ÿè§‰å°±åƒé­”æ³•ğŸ”¥

![Automatic reconnection](https://germano.dev/assets/static/sse-auto-reconnect.7900e78.b190f19887f331ddb680b6ba6bc4921e.gif)

## 7. æ€»ç»“

WebSockets æ˜¯å»ºç«‹åœ¨ HTTP å’Œ TCP ä¹‹ä¸Šçš„å¤§å‹æœºåˆ¶ï¼Œæä¾›äº†ä¸€å¥—æå…¶ç‰¹å®šçš„åŠŸèƒ½ï¼Œå³åŒå‘ä½å»¶è¿Ÿé€šä¿¡ã€‚

ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œå®ƒä»¬å¼•å…¥äº†è®¸å¤šå¤æ‚æ€§ï¼Œæœ€ç»ˆä½¿å¾—å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å®ç°æ¯”å®Œå…¨åŸºäº HTTP çš„è§£å†³æ–¹æ¡ˆæ›´åŠ å¤æ‚ã€‚

è¿™äº›å¤æ‚æ€§å’Œé™åˆ¶å·²ç»åœ¨æ–°çš„è§„èŒƒï¼ˆ[RFC 7692](https://tools.ietf.org/html/rfc7692)ï¼Œ[RFC 8441](https://tools.ietf.org/html/rfc8441)ï¼‰ä¸­å¾—åˆ°äº†è§£å†³ï¼Œå¹¶å°†é€æ¸åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨åº“ä¸­å®ç°ã€‚

ç„¶è€Œï¼Œå³ä½¿åœ¨æ²¡æœ‰æŠ€æœ¯ç¼ºé™·çš„æƒ…å†µä¸‹ï¼ŒWebSockets ä»ç„¶æ˜¯ä¸€é¡¹ç›¸å½“å¤æ‚çš„æŠ€æœ¯ï¼Œæ¶‰åŠå¤§é‡é¢å¤–çš„å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä»£ç ã€‚å› æ­¤ï¼Œæ‚¨åº”ä»”ç»†è€ƒè™‘æ˜¯å¦å€¼å¾—å¢åŠ å¤æ‚æ€§ï¼Œæˆ–è€…æ˜¯å¦å¯ä»¥é€šè¿‡æ›´ç®€å•çš„è§£å†³æ–¹æ¡ˆï¼ˆå¦‚ Server-Sent Eventsï¼‰å»è§£å†³é—®é¢˜ã€‚

---

å°±è¿™äº›å†…å®¹äº†ï¼Œæœ‹å‹ä»¬ï¼å¸Œæœ›ä½ ä»¬è§‰å¾—è¿™ç¯‡æ–‡ç« æœ‰è¶£ï¼Œä¹Ÿèƒ½ä»ä¸­å­¦åˆ°ä¸€äº›æ–°ä¸œè¥¿ã€‚

å¦‚æœä½ æƒ³å°è¯•ä¸€ä¸‹ Server-Sent Events å’Œ WebSocketsï¼Œå¯ä»¥è‡ªç”±åœ°åœ¨ GitHub ä¸ŠæŸ¥çœ‹[æ¼”ç¤º Demo ä»£ç ](https://github.com/tyrion/sse-websockets-demo)ã€‚

æˆ‘ä¹Ÿé¼“åŠ±ä½ ä»¬é˜…è¯»ä¸‹ [SSE çš„è§„èŒƒ](https://html.spec.whatwg.org/#server-sent-events)ï¼Œå› ä¸ºå®ƒè§£é‡Šå¾—éå¸¸æ¸…æ™°ï¼ŒåŒ…å«äº†å¾ˆå¤šç¤ºä¾‹ã€‚