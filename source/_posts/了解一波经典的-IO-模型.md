---
title: äº†è§£ä¸€æ³¢ç»å…¸çš„ I/O æ¨¡å‹
toc: true
comments: true
popular_posts: false
mathjax: true
top: false
date: 2020-05-19 15:19:14
tags: I/Oæ¨¡å‹
categories:
  - [è®¡ç®—æœºç½‘ç»œ]
  - [æ“ä½œç³»ç»Ÿ]
thumbnail: https://mypic-1258313760.cos.ap-guangzhou.myqcloud.com/img/20200519233557.png
keywords: "computer network, operating system, NIO, BIO"
---

æœ€è¿‘è¯»äº†æ³¢ç½‘ç»œ I/O ç›¸å…³çš„æ–‡ç« ï¼Œåšä¸‹æ€»ç»“ã€æ‘˜å½•ã€‚ï¼ˆæœªå®Œï¼‰

## ç»å…¸ I/O æ¨¡å‹

- {% checkbox red checked, é˜»å¡å¼ I/Oï¼ˆblocking I/Oï¼‰ %}
- {% checkbox red checked, éé˜»å¡å¼ I/Oï¼ˆnon-blocking I/Oï¼‰ %}
- {% checkbox red, I/O å¤šè·¯å¤ç”¨ï¼ˆI/O multiplexingï¼‰ %}
- {% checkbox cyan , ä¿¡å·é©±åŠ¨å¼ I/Oï¼ˆsignal driven I/Oï¼‰ %}
- {% checkbox cyan , å¼‚æ­¥ I/Oï¼ˆasynchronous I/Oï¼‰ %}

### é˜»å¡å¼ I/O æ¨¡å‹

å¯¹äºé˜»å¡å¼ I/Oï¼Œä»¥å¥—æ¥å­—ï¼ˆSocketï¼‰çš„è¾“å…¥æ“ä½œä¸ºä¾‹ã€‚

- 1ã€é¦–å…ˆåº”ç”¨è¿›ç¨‹å‘èµ· I/O ç³»ç»Ÿè°ƒç”¨åï¼Œåº”ç”¨è¿›ç¨‹é˜»å¡ï¼Œè½¬åˆ°å†…æ ¸ç©ºé—´å¤„ç†ã€‚
- 2ã€ä¹‹åï¼Œå†…æ ¸å¼€å§‹ç­‰å¾…æ•°æ®ï¼Œç­‰å¾…æ•°æ®åˆ°è¾¾ä¹‹åï¼Œå°†å†…æ ¸ä¸­çš„æ•°æ®æ‹·è´åˆ°ç”¨æˆ·çš„ç¼“å†²åŒºä¸­ï¼Œæ•´ä¸ª I/O å¤„ç†å®Œæ¯•åè¿”å›è¿›ç¨‹ã€‚æœ€ååº”ç”¨è¿›ç¨‹è§£é™¤é˜»å¡çŠ¶æ€ï¼Œå¤„ç†æ•°æ®ã€‚

<!-- more -->

![é˜»å¡å¼ç¤ºä¾‹](https://mypic-1258313760.cos.ap-guangzhou.myqcloud.com/img/20200519164453.png)

ä¸Šå›¾ä»¥ UDP çš„ Socket è°ƒç”¨ä¸ºä¾‹ï¼Œè¿›ç¨‹è°ƒç”¨ recvfrom åï¼Œç³»ç»Ÿè°ƒç”¨ç›´åˆ°æ•°æ®æŠ¥åˆ°è¾¾ä¸”è¢«å¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´ä¸­æˆ–å‘ç”Ÿé”™è¯¯æ‰è¿”å›ã€‚è¿›ç¨‹ä»è°ƒç”¨å¼€å§‹åˆ°å®ƒè¿”å›çš„æ•´æ®µæ—¶é—´å†…æ˜¯è¢«é˜»å¡çš„ã€‚recvfrom æˆåŠŸè¿”å›åï¼Œåº”ç”¨è¿›ç¨‹å¼€å§‹å¤„ç†æ•°æ®æŠ¥ã€‚

> é»˜è®¤æƒ…å½¢ï¼ŒLinux/Unix çš„æ‰€æœ‰ Socket æ˜¯é˜»å¡çš„ã€‚

é™„ï¼šåŸºäº UDP åè®®çš„ Socket ç¨‹åºå‡½æ•°è°ƒç”¨è¿‡ç¨‹å›¾

![åŸºäº UDP åè®®çš„ Socket ç¨‹åºå‡½æ•°è°ƒç”¨è¿‡ç¨‹å›¾](https://mypic-1258313760.cos.ap-guangzhou.myqcloud.com/img/20200519164642.png)

>ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒæœåŠ¡ç«¯éœ€è¦ç®¡ç†å¤šä¸ªå®¢æˆ·ç«¯è¿æ¥ï¼ˆå¤„ç†å¹¶å‘è¿æ¥ï¼‰ï¼Œè€Œ recvfrom åªèƒ½ç›‘è§†å•ä¸ª Socketã€‚ä¸Šå›¾çš„é˜»å¡å¼ I/O æ¨¡å‹è¡¨ç¤ºçš„æ˜¯ä¸€å¯¹ä¸€æ²Ÿé€šçš„æƒ…å½¢ï¼Œä½¿ç”¨å¤šçº¿ç¨‹/è¿›ç¨‹ + é˜»å¡å¼ I/O æˆ‘ä»¬å¯ä»¥ç®¡ç†å¤šä¸ª Socket ï¼Œå®ç°ä¸€å¯¹å¤šæœåŠ¡ã€‚

### éé˜»å¡å¼ I/O æ¨¡å‹

åœ¨ç±» Unix ç³»ç»Ÿä¸‹ï¼Œå¯ä»¥æŠŠä¸€ä¸ª Socket è®¾ç½®æˆéé˜»å¡çš„ã€‚è¿™æ„å‘³ç€å†…æ ¸åœ¨æ•°æ®æŠ¥æ²¡æœ‰å‡†å¤‡å¥½æ—¶ä¸ä¼šé˜»å¡åº”ç”¨è¿›ç¨‹ï¼ˆç¡çœ æ€ï¼‰ï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ªé”™è¯¯ã€‚

![éé˜»å¡å¼ I/O æ¨¡å‹ç¤ºä¾‹å›¾](https://mypic-1258313760.cos.ap-guangzhou.myqcloud.com/img/20200519170609.png)

ä¸Šå›¾ä»¥ UDP çš„ Socket è°ƒç”¨ä¸ºä¾‹ï¼Œè¿›ç¨‹åå¤è°ƒç”¨ recvfromï¼ˆpollingï¼Œè½®è¯¢ï¼‰ï¼Œæ— æ•°æ®è¿”å› EWOULDBLOCK é”™è¯¯ï¼Œç›´è‡³æ•°æ®æŠ¥å‡†å¤‡å¥½ã€‚

é—®é¢˜ï¼š**å•è¿›ç¨‹å¤„ç†æ•°æ®æŠ¥ï¼Œä¸åŒäºé˜»å¡I/Oï¼Œç”±äºéœ€è¦åå¤ pollingï¼Œéé˜»å¡ I/O ä¼šè€—è´¹å¤§é‡çš„ CPU èµ„æºï¼Œè¿›ç¨‹é˜»å¡ä¸è€—è´¹ CPU èµ„æº**ã€‚å¦‚æœè€ä¸Šäº†å¤šè¿›ç¨‹ï¼Œé‚£è€—è´¹ï¼Œæ˜¯ä¸å¯æ‰¿å—çš„ã€‚

å…³äºé˜»å¡çš„åŸç†ï¼Œè¿™ç¯‡æ–‡ç« æœ‰ç®€å•ä»‹ç»[âœ”ğŸ”—](https://zhuanlan.zhihu.com/p/63179839)ã€‚

### I/O å¤šè·¯å¤ç”¨æ¨¡å‹

ä»€ä¹ˆæ˜¯å¤šè·¯å¤ç”¨ï¼Ÿå¤šè·¯æŒ‡çš„æ˜¯å¤šä¸ªé€šé“ï¼Œä¸€èˆ¬å°±æ˜¯å¤šä¸ªç½‘ç»œè¿æ¥çš„ I/Oï¼›å¤ç”¨æŒ‡çš„æ˜¯å¤šä¸ªé€šé“å¤ç”¨åœ¨ä¸€ä¸ªå¤ç”¨å™¨ä¸Šã€‚

å¼•å…¥å¤šè·¯å¤ç”¨æœºåˆ¶çš„ä¸€ä¸ªç›®çš„æ˜¯ä¸ºäº†å¤„ç†å¤šä¸ªç½‘ç»œè¿æ¥ I/Oã€‚

> I/Oå¤šè·¯å¤ç”¨æ–¹æ³•çš„æ¼”è¿›å†ç¨‹ï¼šselect æ¨¡å‹-> poll æ¨¡å‹-> epoll æ¨¡å‹

#### select æ¨¡å‹

![selectå¤šè·¯å¤ç”¨ç¤ºä¾‹](https://mypic-1258313760.cos.ap-guangzhou.myqcloud.com/img/20200519214552.png)

ä¸Šå›¾æ‰€ç¤ºçš„æ•´ä¸ªç”¨æˆ·è¿›ç¨‹ä¸€èˆ¬ä¸€ç›´æ˜¯è¢«é˜»å¡çš„ï¼ˆblockingï¼‰ï¼Œå³è¢« selectï¼ˆå¤ç”¨å™¨ï¼‰ æ‰€é˜»å¡ï¼Œå¤šä¸ª Socket è¢«æ³¨å†Œåœ¨ select ä¸­ã€‚è¿›ç¨‹é˜»å¡äº select è°ƒç”¨ï¼Œç­‰å¾…æ•°æ®æŠ¥å¥—æ¥å­—å˜ä¸ºå¯è¯»ï¼Œä¸€ä½† select è¿”å›å¥—æ¥å­—å¯è¯»ï¼Œç³»ç»Ÿè°ƒç”¨ recvfrom æŠŠæ‰€è¯»æ•°æ®æŠ¥å¤åˆ¶åˆ°åº”ç”¨è¿›ç¨‹ç¼“å†²åŒºã€‚

{% note blue, é—®é¢˜æ¥äº†ï¼Ÿä¸ºäº†å¤„ç†å¤šä¸ªç½‘ç»œè¿æ¥ I/Oï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡å¤šçº¿ç¨‹/è¿›ç¨‹çš„æ–¹å¼å®ç°ï¼Œå¤šè·¯å¤ç”¨çš„ä¼˜åŠ¿ä½•åœ¨ï¼Ÿè¿™é‡Œçš„å¤šè·¯å¤ç”¨æ¨¡å‹ä¼¼ä¹æ¯”é˜»å¡å¼ I/O æ¨¡å‹æ›´ä¸ºå¤æ‚ï¼Œä½†å®ƒæœ€å¤§çš„ä¼˜åŠ¿åœ¨äºç”¨æˆ·å¯ä»¥åœ¨ä¸€ä¸ªè¿›ç¨‹/çº¿ç¨‹å†…åŒæ—¶å¤„ç†å¤šä¸ª socket çš„ IO è¯·æ±‚ã€‚ç”¨æˆ·å¯ä»¥æ³¨å†Œå¤šä¸ª socketï¼Œç„¶åä¸æ–­åœ°è°ƒç”¨ select è¯»å–è¢«æ¿€æ´»çš„ socketï¼Œå³å¯è¾¾åˆ°åœ¨åŒä¸€ä¸ªçº¿ç¨‹å†…åŒæ—¶å¤„ç†å¤šä¸ª IO è¯·æ±‚çš„ç›®çš„ã€‚ï¼ˆselect å¯æ¥å—çš„ socket æè¿°ç¬¦æ•°ä¼šæœ‰ä¸€å®šé™åˆ¶ï¼‰ %}

{% note red, æˆ‘ä»¬çŸ¥é“ï¼Œæ“ä½œç³»ç»Ÿå¤šä¸ªè¿›ç¨‹/çº¿ç¨‹çš„å¼€é”€ç»´æŠ¤è¿˜æ˜¯è›®å¤§çš„ã€‚å¯¹äºé«˜å¹¶å‘åœºæ™¯ï¼Œå¦‚æœä¸€å°æœºå™¨è¦ç»´æŠ¤ 1 ä¸‡ä¸ªè¿æ¥ï¼ˆC10Ké—®é¢˜ï¼‰ï¼Œä½¿ç”¨å¤šçº¿ç¨‹/è¿›ç¨‹çš„æ–¹å¼å¤„ç†ï¼Œæ“ä½œç³»ç»Ÿæ˜¯æ— æ³•æ‰¿å—çš„ã€‚å¦‚æœç»´æŒ 1 äº¿ç”¨æˆ·åœ¨çº¿éœ€è¦ 10 ä¸‡å°æœåŠ¡å™¨ï¼Œæˆæœ¬é‚£æ˜¯ç›¸å½“çš„é«˜ã€‚ %}

{% note yellow, æœåŠ¡ç«¯å•æœºæœ€å¤§ TCP è¿æ¥æ•° = å®¢æˆ·ç«¯ IP æ•° Ã— å®¢æˆ·ç«¯ç«¯å£æ•°ï¼Œå¯¹äº IPv4ï¼Œå®¢æˆ·ç«¯çš„ IP æ•°æœ€å¤šä¸º $2^{32}$ï¼Œå®¢æˆ·ç«¯çš„ç«¯å£æ•°æœ€å¤šä¸º $2^{16}$ã€‚è¿™åªæ˜¯ç†è®ºä¸Šé™ï¼Œæ¯ä¸ª TCP è¿æ¥çš„å»ºç«‹ä¼šå—åˆ¶äºæ“ä½œç³»ç»Ÿå†…å­˜ç­‰å› ç´ çš„å½±å“ã€‚%}

#### epoll æ¨¡å‹

æ–°æ¨¡å‹çš„å‡ºç°è‚¯å®šæ˜¯ä¸ºäº†è§£å†³æ—§æ¨¡å‹çš„é—®é¢˜ï¼Œé‚£ä¹ˆ select æ¨¡å‹æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿæ¯æ¬¡ Socket æ‰€åœ¨çš„æ–‡ä»¶æè¿°ç¬¦é›†åˆä¸­æœ‰ Socket å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œselect éƒ½éœ€è¦é€šè¿‡è½®è¯¢çš„æ–¹å¼å»æ£€æŸ¥ï¼Œè€Œ epoll å¼•å…¥äº† CallBackï¼ˆå›è°ƒï¼‰æœºåˆ¶ï¼Œå½“æŸä¸ªæ–‡ä»¶æè¿°ç¬¦å‘é€å˜åŒ–çš„æ—¶å€™ï¼Œä¸»åŠ¨é€šçŸ¥ã€‚éšç€ç›‘å¬çš„ Socket æ•°æ®å¢åŠ çš„æ—¶å€™ï¼Œæ•ˆç‡ç›¸æ¯”äº select çš„è½®è¯¢å¿«å¤šäº†ã€‚

äº†è§£ epoll çš„æœ¬è´¨ -> [å¦‚æœè¿™ç¯‡æ–‡ç« è¯´ä¸æ¸…epollçš„æœ¬è´¨ï¼Œé‚£å°±è¿‡æ¥ææ­»æˆ‘å§ï¼ ï¼ˆ2ï¼‰](https://zhuanlan.zhihu.com/p/64138532)


## å‚è€ƒ

- [ã€ŠUNIXç½‘ç»œç¼–ç¨‹ å·1ï¼šå¥—æ¥å­—è”ç½‘APIã€‹](https://book.douban.com/subject/4859464/)
- [è¶£è°ˆç½‘ç»œåè®®](https://time.geekbang.org/column/article/9293)
- [RPCå®æˆ˜ä¸æ ¸å¿ƒåŸç†](https://time.geekbang.org/column/article/204696)
- [å¦‚æœè¿™ç¯‡æ–‡ç« è¯´ä¸æ¸…epollçš„æœ¬è´¨ï¼Œé‚£å°±è¿‡æ¥ææ­»æˆ‘å§ï¼](https://zhuanlan.zhihu.com/p/63179839)
- [5ç§ç½‘ç»œIOæ¨¡å‹ï¼ˆæœ‰å›¾ï¼Œå¾ˆæ¸…æ¥šï¼‰](https://zhuanlan.zhihu.com/p/54580385)
- [ã€ŠNginxé«˜æ€§èƒ½WebæœåŠ¡å™¨è¯¦è§£ã€‹](https://book.douban.com/subject/25773187/)